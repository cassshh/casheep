<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-lazy-pages/iron-lazy-pages.html">
<dom-module id="casheep-app">
    <template>
        <style>
             :host {
                --app-primary-color: #34373c;
                --app-secondary-color: black;
                display: block;
            }
            
            app-header,
            app-toolbar {
                color: #fff;
                background-color: var(--app-primary-color);
                height: 46px;
            }
            
            app-toolbar,
            iron-lazy-pages {
                margin: 0 auto;
                max-width: 1240px;
            }
            
            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }
            
            .logo {
                text-align: center;
            }
            
            .logo a {
                font-size: 16px;
                font-weight: 600;
                letter-spacing: 0.3em;
                color: #fff;
            }
            
            a {
                text-transform: none;
                text-decoration: none;
                /* required for IE 11, so this <a> can receive pointer events */
                display: inline-block;
                pointer-events: auto;
            }
            
            paper-progress {
                display: block;
                width: 100%;
                --paper-progress-active-color: rgba(255, 255, 255, 0.5);
                --paper-progress-container-color: #0D87E9;
                --paper-progress-indeterminate-cycle-duration: 3s;
            }
            
            a paper-icon-button,
            a:active paper-icon-button,
            a:visited paper-icon-button {
                color: #fff;
            }
            
            paper-icon-button.rounded {
                --iron-icon: {
                    border-radius: 50%;
                    overflow: hidden;
                }
            }
        </style>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
        <app-header>
            <app-toolbar>
                <a href="/main" tabindex="-1">
                    <paper-icon-button icon="icons:favorite"></paper-icon-button>
                </a>
                <div class="logo" main-title><a href="/">CASHEEP</a></div>
                <!--<a href="/404">-->
                <template is="dom-if" if="[[!_isLoggedIn(user)]]">
                    <paper-icon-button icon="account-circle" on-tap="signIn"></paper-icon-button>
                </template>
                <template is="dom-if" if="[[_isLoggedIn(user)]]">
                    <paper-icon-button class="rounded" src="[[user.photoURL]]" on-tap="signOut"></paper-icon-button>
                </template>
                <!--</a>-->
                <template is="dom-if" if="[[loading]]">
                    <paper-progress indeterminate bottom-item></paper-progress>
                </template>
            </app-toolbar>
        </app-header>
        <iron-lazy-pages attr-for-selected="data-route" selected="[[page]]" loading="{{loading}}" hide-immediatly>
            <template is="iron-lazy-page" data-route="404">
                <sheep-404></sheep-404>
            </template>
            <template is="iron-lazy-page" data-route="main">
                <sheep-main></sheep-main>
            </template>
        </iron-lazy-pages>
    </template>
    <script src="https://www.gstatic.com/firebasejs/3.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.6.8/firebase-auth.js"></script>
    <!--firebase-app - The core firebase client (required).
    firebase-auth - Firebase Authentication (optional).
    firebase-database - The Firebase Realtime Database (optional).
    firebase-storage - Firebase Storage (optional).
    firebase-messaging - Firebase Cloud Messaging (optional).-->
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDR4XSKm4feHiEsWMfrn7hkERhhosWqQXg",
            authDomain: "casheep-develop.firebaseapp.com",
            databaseURL: "https://casheep-develop.firebaseio.com",
            storageBucket: "casheep-develop.appspot.com",
            messagingSenderId: "1069480592810"
        };
        firebase.initializeApp(config);
    </script>
    <script type="text/javascript" src="../js/config.js"></script>
    <script>
        Polymer({

            is: 'casheep-app',

            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                },
                loading: {
                    type: Boolean,
                    notify: true
                },
                user: {
                    type: Object,
                    value: null,
                    notify: true
                }
            },

            observers: [
                '_routePageChanged(routeData.page)'
            ],

            created: function () {
                var m = 'font-family:monospace;color:#0D87E9';
                var title = '%c               _  V ' + config.version_code + ' | ' + config.version_name +
                    '\n  ___ __ _ ___| |__   ___  ___ _ __  \n / __/ _` / __| \'_ \\ / _ \\/ _ \\ \'_ \\ \n| (_| (_| \\__ \\ | | |  __/  __/ |_) |\n \\___\\__,_|___/_| |_|\\___|\\___| .__/ \n                              |_|    \n';
                var desc =
                    '========================================\nYou opened the console! Know some code,\ndo you? Keep on doin\' watcha doin\' ;)\n========================================\n';
                var message = title + desc;
                if (window.console) console.log(message, m);
                this.removeAttribute('unresolved');
            },

            ready: function () {
                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        // User is signed in.
                        this._log("signed in");
                        this.user = user;
                    } else {
                        // No user is signed in.
                        this._log("No user");
                        this.user = null;
                    }
                }.bind(this));
            },

            signIn: function () {
                this._log("Press Signin");
                var provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/plus.login');
                firebase.auth().signInWithRedirect(provider);
                firebase.auth().getRedirectResult().then(function (result) {
                    if (result.credential) {
                        // This gives you a Google Access Token. You can use it to access the Google API.
                        var token = result.credential.accessToken;
                        this._log("fireauth token: " + token);
                    }
                    // The signed-in user info.
                    var user = result.user;
                    this._log("fireauth user: " + user);
                }.bind(this)).catch(function (error) {
                    //Handle Erros
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    this._log("fireauth error: " + errorCode + " " + errorMessage + " " + email +
                        " " + credential);
                }.bind(this));
            },

            signOut: function () {
                firebase.auth().signOut().then(function() {
                    //Success
                    this._log("Logged out");
                }.bind(this), function (error) {
                    //Error
                    this._log("Logout error: " + error);
                }.bind(this));
            },

            _isLoggedIn: function (user) {
                return user != null;
            },

            _routePageChanged: function (page) {
                this._log("_routePageChanged: " + page);
                this.page = page || 'main';
            },

            _pageChanged: function (page) {
                this._log("_pageChanged: " + page);
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('sheep-' + page + '.html');
                //var resolvedPageUrl = this.resolveUrl('casheep-app.html');
                this.importHref(resolvedPageUrl, null, this._showPage404, true);
            },

            _showPage404: function () {
                this.page = '404';
            },

            _log: function (msg) {
                console.log(msg);
            }
        });
    </script>
</dom-module>